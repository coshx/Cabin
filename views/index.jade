h1 Cabin
p Welcome to #{title}
.query

h2#result-header(style="display:none;") Here's what I found...
h2#empty-results-header(style="display:none;") Err... nevermind, didn't find anything. Try again!
#results

script(id="query-template", type="text/x-handlebars-template").
  <div class="query">
    <form id="query-form" method="get" action="/query.json">
      <p><label for="host">Host:</label><input type="text" name="host" placeholder="hostname" /></p>
      <p><label for="timestamp">Timestamp:</label><input type="number" name="timestamp" placeholder="12345678"  /></p>
      <p><label for="application">Application:</label><input type="text" name="application" placeholder="Your App Name" /></p>
      <p><label for="location">Location:</label><input type="text" name="location" placeholder="MyFileName.rb:123" /></p>
      <p><label for="tags">Tags:</label><input type="text" name="tags" placeholder="Tag1, Tag2, Tag3" /></p>
      <p><label for="severity">Severity:</label><input type="text" name="severity" placeholder="info" /></p>
      <p><label for="message">Message:</label><input type="text" name="message" placeholder="Client ABC tried to access /blah" /></p>
      <p><input type="submit" value="Query Away!" />&nbsp;&nbsp;<input type="reset" value="Clear This Form!" /></p>
    </form>
  </div>
  
script(id="logs-list-template", type="text/x-handlebars-template").
  <ul class="logs-list">
    {{#each logs}}
      <li class="log">
        <div class="log-body">
          <p>{{this.host}}</p>
          <p>{{this.timestamp}}</p>
          <p>{{this.application}}</p>
          <p>{{this.location}}</p>
          <p>{{logTags this.tags}}</p>
          <p>{{this.severity}}</p>
          <p>{{this.message}}</p>
        </div>
      </li>
    {{/each}}
  </ul>

script(type="text/javascript")
  $(document).ready(function() {
    Handlebars.registerHelper("logTags", function(tags) {
      return tags.join(", ");
    });

    var queryTemplate = $("#query-template").html();
    var template = Handlebars.compile(queryTemplate);
    $(".query").html(template());

    $("#get-all").click(function() {
      $.get("/all.json", function(data) {
        var resultsTemplate = $("#logs-list-template").html();
        var results = Handlebars.compile(resultsTemplate);
        var renderedLogs = results({logs: data.logs});
        $("#results").html(renderedLogs);
      });
    });
    
    $("#query-form").submit(function(e) {
      e.preventDefault();
      var query = $(this).serialize();
      $.get("/query.json?" + query, function(data) {
        $("#result-header").show();
        $("#results").empty();
        if (data.logs.length === 0) {
          $("#empty-results-header").show();
          return;
        } else {
          $("#empty-results-header").hide();
        }
        
        var resultsTemplate = $("#logs-list-template").html();
        var results = Handlebars.compile(resultsTemplate);
        var renderedLogs = results({logs: data.logs});
        $("#results").html(renderedLogs);        
      });      
    });
  });
